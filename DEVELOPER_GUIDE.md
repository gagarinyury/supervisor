# üöÄ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ - –ü—Å–∏—Ö–æ–¢—Ä–µ–Ω–µ—Ä –ë–æ—Ç

## üìã –û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞

**–ü—Å–∏—Ö–æ–¢—Ä–µ–Ω–µ—Ä** - —ç—Ç–æ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Telegram-–±–æ—Ç –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç–æ–≤ —á–µ—Ä–µ–∑ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º–∏ AI-–ø–∞—Ü–∏–µ–Ω—Ç–∞–º–∏, —Å–æ–∑–¥–∞–Ω–Ω—ã–º–∏ —Å –ø–æ–º–æ—â—å—é Claude API.

### üéØ –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- ü§ñ AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã—Ö –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ (15 –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ä–∞—Å—Å—Ç—Ä–æ–π—Å—Ç–≤)
- üí¨ –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–∏–µ —Å–µ—Å—Å–∏–∏
- üìä –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
- üé§ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- üìà –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –æ–±—É—á–µ–Ω–∏—è

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

```
/root/supervisor/
‚îú‚îÄ‚îÄ telegram-bot.js      # –û—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç-–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä (2554 —Å—Ç—Ä–æ–∫–∏)
‚îú‚îÄ‚îÄ patient-system.js    # –°–∏—Å—Ç–µ–º–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ 
‚îú‚îÄ‚îÄ cache-manager.js     # –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤
‚îú‚îÄ‚îÄ voice-handler.js     # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
‚îú‚îÄ‚îÄ contact-api.js       # –í–µ–± API –¥–ª—è –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã—Ö —Ñ–æ—Ä–º
‚îî‚îÄ‚îÄ send-notification.js # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram
```

### API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- **Anthropic Claude API** - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ –∏ –∞–Ω–∞–ª–∏–∑ —Å–µ—Å—Å–∏–π
- **Telegram Bot API** - –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **OpenAI Whisper API** - –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- **Express API** - –í–µ–±-—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã—Ö —Ñ–æ—Ä–º

---

## ‚öôÔ∏è –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
cd /root/supervisor
npm install
```

### 2. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è
–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env`:
```bash
# Anthropic API (–æ—Å–Ω–æ–≤–Ω–æ–π –¥–ª—è AI)
ANTHROPIC_API_KEY=–≤–∞—à_–∫–ª—é—á_anthropic_api

# Telegram Bot
TELEGRAM_BOT_TOKEN=–≤–∞—à_—Ç–æ–∫–µ–Ω_telegram_–±–æ—Ç–∞

# OpenAI API (–¥–ª—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π)
OPENAI_API_KEY=–≤–∞—à_–∫–ª—é—á_openai_api
```

### 3. –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞
```bash
# –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∑–∞–ø—É—Å–∫
./unified-start.sh

# –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ PM2 (–¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞)
./unified-start.sh pm2
```

---

## üîß –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞

#### **telegram-bot.js** - –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä
```javascript
// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
function getUserSession(userId) {
  if (!userSessions[userId]) {
    userSessions[userId] = {
      state: 'idle',           // idle, in_dialog, waiting_analysis
      currentPatient: null,    // –î–∞–Ω–Ω—ã–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞
      conversation: [],        // –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞
      stats: { ... }          // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    };
  }
  return userSessions[userId];
}

// –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
bot.onText(/\/new/, createRandomPatient);
bot.onText(/\/custom/, showCategoryMenu);
bot.onText(/\/analyze/, analyzeSession);
bot.onText(/\/end/, endDialog);
```

#### **patient-system.js** - AI –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
```javascript
class PatientSystem {
  // 15 –∫–∞—Ç–µ–≥–æ—Ä–∏–π √ó 52 –ø–æ–¥—Ç–∏–ø–∞ —Ä–∞—Å—Å—Ç—Ä–æ–π—Å—Ç–≤
  constructor() {
    this.casesDB = {
      anxiety: { /* —Ç—Ä–µ–≤–æ–∂–Ω—ã–µ —Ä–∞—Å—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ */ },
      mood: { /* —Ä–∞—Å—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è */ },
      trauma: { /* —Ç—Ä–∞–≤–º–∞—Ç–∏—á–µ—Å–∫–∏–µ */ },
      // ... –≤—Å–µ–≥–æ 15 –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    };
  }

  async generateRandomPatient() {
    // –°–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ + Claude API
    const patient = await this.cacheManager.createMessage({
      system: "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –≤ –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–π –ø—Å–∏—Ö–æ–ª–æ–≥–∏–∏...",
      messages: [{ role: "user", content: casePrompt }],
      maxTokens: 1000
    });
    return patient;
  }
}
```

#### **cache-manager.js** - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤
```javascript
class CacheManager {
  async createMessage(options) {
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª–∏–Ω–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤
    if (system && system.length > 1000) {
      systemPrompt = [{
        type: "text",
        text: system,
        cache_control: { type: "ephemeral" } // –≠–∫–æ–Ω–æ–º–∏—è –¥–æ 90%
      }];
    }
    
    return await this.anthropic.messages.create({
      model: 'claude-3-5-haiku-20241022',
      max_tokens: maxTokens,
      system: systemPrompt,
      messages
    });
  }
}
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

#### –ü–∞—Ü–∏–µ–Ω—Ç (JSON —Ñ–æ—Ä–º–∞—Ç)
```json
{
  "name": "–ê–Ω–Ω–∞ –°–µ—Ä–≥–µ–µ–≤–Ω–∞ –í–æ–ª–∫–æ–≤–∞",
  "age": 34,
  "gender": "–∂–µ–Ω—Å–∫–∏–π",
  "profession": "–£—á–∏—Ç–µ–ª—å –Ω–∞—á–∞–ª—å–Ω—ã—Ö –∫–ª–∞—Å—Å–æ–≤",
  "problem": "–ü–∞–Ω–∏—á–µ—Å–∫–∏–µ –∞—Ç–∞–∫–∏ –≤ —à–∫–æ–ª–µ",
  "symptoms": ["—É—á–∞—â–µ–Ω–Ω–æ–µ —Å–µ—Ä–¥—Ü–µ–±–∏–µ–Ω–∏–µ", "–≥–æ–ª–æ–≤–æ–∫—Ä—É–∂–µ–Ω–∏–µ"],
  "motivation": "–•–æ—á—É –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–µ",
  "openness": "–ì–æ—Ç–æ–≤–∞ –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º, –Ω–æ –Ω–∞—Å—Ç–æ—Ä–æ–∂–µ–Ω–Ω–∞",
  "history": "–ü—Ä–æ–±–ª–µ–º–∞ –Ω–∞—á–∞–ª–∞—Å—å –ø–æ—Å–ª–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π",
  "triggers": ["–∑–≤–æ–Ω–æ–∫ –Ω–∞ —É—Ä–æ–∫", "–±–æ–ª—å—à–∏–µ —Å–∫–æ–ø–ª–µ–Ω–∏—è –¥–µ—Ç–µ–π"],
  "coping": ["–¥—ã—Ö–∞—Ç–µ–ª—å–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è", "–∏–∑–±–µ–≥–∞–Ω–∏–µ —à–∫–æ–ª—å–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π"],
  "defenses": ["—Ä–∞—Ü–∏–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è", "–∏–∑–±–µ–≥–∞–Ω–∏–µ"],
  "speech": "–ì–æ–≤–æ—Ä–∏—Ç —Ç–∏—Ö–æ, —á–∞—Å—Ç–æ –¥–µ–ª–∞–µ—Ç –ø–∞—É–∑—ã",
  "resistance": "–ú–æ–∂–µ—Ç —É—Ö–æ–¥–∏—Ç—å –æ—Ç –±–æ–ª–µ–∑–Ω–µ–Ω–Ω—ã—Ö —Ç–µ–º",
  "background": "–†–æ—Å–ª–∞ –≤ —Å—Ç—Ä–æ–≥–æ–π —Å–µ–º—å–µ —É—á–∏—Ç–µ–ª–µ–π",
  "meta": {
    "category": "anxiety",
    "diagnosis": "–ü–∞–Ω–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å—Å—Ç—Ä–æ–π—Å—Ç–≤–æ",
    "complexity": 3,
    "openness": "neutral",
    "created": "2024-06-10T07:25:43.326Z"
  }
}
```

#### –°–µ—Å—Å–∏—è (JSON —Ñ–æ—Ä–º–∞—Ç)
```json
{
  "patient": { /* –¥–∞–Ω–Ω—ã–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞ */ },
  "conversation": [
    {
      "therapist": "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –ø—Ä–∏–≤–µ–ª–æ –≤–∞—Å –∫ –ø—Å–∏—Ö–æ–ª–æ–≥—É?",
      "patient": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ... (–Ω–µ–º–Ω–æ–≥–æ –Ω–µ—Ä–≤–Ω–∏—á–∞–µ—Ç) –ú–µ–Ω—è –∑–æ–≤—É—Ç –ê–Ω–Ω–∞, 34 –≥–æ–¥–∞, —è —É—á–∏—Ç–µ–ª—å –Ω–∞—á–∞–ª—å–Ω—ã—Ö –∫–ª–∞—Å—Å–æ–≤. –£ –º–µ–Ω—è –Ω–∞—á–∞–ª–∏—Å—å –ø–∞–Ω–∏—á–µ—Å–∫–∏–µ –∞—Ç–∞–∫–∏ –ø—Ä—è–º–æ –≤ —à–∫–æ–ª–µ..."
    }
  ],
  "analysis": "–ö–ª–∏–µ–Ω—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ä–∞–±–æ—Ç–µ, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —Ç—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å...",
  "timestamp": "2024-06-10T07:25:43-326Z",
  "therapistId": "541619366"
}
```

---

## üö¶ –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞

| –ö–æ–º–∞–Ω–¥–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | –°–æ—Å—Ç–æ—è–Ω–∏–µ |
|---------|----------|-----------|
| `/start` | –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º | –õ—é–±–æ–µ |
| `/new` | –°–æ–∑–¥–∞—Ç—å —Å–ª—É—á–∞–π–Ω–æ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞ | idle |
| `/custom` | –í—ã–±—Ä–∞—Ç—å —Ç–∏–ø –ø–∞—Ü–∏–µ–Ω—Ç–∞ | idle |
| `/patients` | –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞ | idle |
| `/history` | –ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Å—Ç–æ—Ä–∏–∏ —Å–µ—Å—Å–∏–π | –õ—é–±–æ–µ |
| `/analyze` | –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏ | in_dialog |
| `/info` | –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞—Ü–∏–µ–Ω—Ç–µ | in_dialog |
| `/end` | –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é | in_dialog |
| `/stats` | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | –õ—é–±–æ–µ |
| `/feedback` | –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ | –õ—é–±–æ–µ |

---

## üìä –°–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```javascript
// –í–æ–∑–º–æ–∂–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
const STATES = {
  IDLE: 'idle',                    // –û–∂–∏–¥–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥
  IN_DIALOG: 'in_dialog',          // –í–µ–¥–µ—Ç —Å–µ—Å—Å–∏—é —Å –ø–∞—Ü–∏–µ–Ω—Ç–æ–º  
  WAITING_ANALYSIS: 'waiting_analysis', // –û–∂–∏–¥–∞–µ—Ç –∞–Ω–∞–ª–∏–∑
  FEEDBACK_RATING: 'waiting_for_rating', // –í–≤–æ–¥ —Ä–µ–π—Ç–∏–Ω–≥–∞
  FEEDBACK_COMMENT: 'waiting_for_comment' // –í–≤–æ–¥ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
};

// –ü–µ—Ä–µ—Ö–æ–¥—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π
idle ‚Üí in_dialog (–∫–æ–º–∞–Ω–¥—ã /new, /custom, –∑–∞–≥—Ä—É–∑–∫–∞ –ø–∞—Ü–∏–µ–Ω—Ç–∞)
in_dialog ‚Üí waiting_analysis (–∫–æ–º–∞–Ω–¥–∞ /analyze)
in_dialog ‚Üí idle (–∫–æ–º–∞–Ω–¥–∞ /end)
–ª—é–±–æ–µ ‚Üí feedback_* (–∫–æ–º–∞–Ω–¥–∞ /feedback)
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
```bash
# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
node test-caching.js

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
node test-voice.js

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤
node test-patient-save.js
```

### –ü—Ä–∏–º–µ—Ä—ã —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
```javascript
// –¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∞—Ü–∏–µ–Ω—Ç–∞
async function testPatientGeneration() {
  const patient = await patientSystem.generateRandomPatient();
  console.log('‚úÖ –ü–∞—Ü–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω:', patient.name);
}

// –¢–µ—Å—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
async function testCaching() {
  const stats = cacheManager.getStats();
  console.log('üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è:', stats);
}
```

---

## üîÑ –†–∞–±–æ—á–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí /new ‚Üí PatientSystem.generateRandomPatient() 
             ‚Üí Claude API ‚Üí –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ patients/ 
             ‚Üí –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è ‚Üí –ù–∞—á–∞–ª–æ –¥–∏–∞–ª–æ–≥–∞
```

### 2. –í–µ–¥–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
```
–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí CacheManager.createMessage() 
                      ‚Üí Claude API (—Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
                      ‚Üí –û—Ç–≤–µ—Ç –ø–∞—Ü–∏–µ–Ω—Ç–∞ ‚Üí –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
```

### 3. –ê–Ω–∞–ª–∏–∑ —Å–µ—Å—Å–∏–∏
```
/analyze ‚Üí Claude API (—Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å—É–ø–µ—Ä–≤–∏–∑–æ—Ä–∞)
        ‚Üí –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
        ‚Üí –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ sessions/
```

### 4. –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
```
–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Üí VoiceHandler.processVoiceMessage()
                   ‚Üí –°–∫–∞—á–∏–≤–∞–Ω–∏–µ OGG ‚Üí FFmpeg –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è 
                   ‚Üí OpenAI Whisper ‚Üí –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è 
                   ‚Üí –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∫ —Ç–µ–∫—Å—Ç
```

---

## üìÅ –§–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞

```
/root/supervisor/
‚îú‚îÄ‚îÄ patients/           # –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø–∞—Ü–∏–µ–Ω—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ {userId}/      # –ü–∞–ø–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îÇ       ‚îî‚îÄ‚îÄ {–∏–º—è}_{timestamp}.json
‚îú‚îÄ‚îÄ sessions/          # –ê—Ä—Ö–∏–≤ —Å–µ—Å—Å–∏–π  
‚îÇ   ‚îî‚îÄ‚îÄ {userId}/
‚îÇ       ‚îî‚îÄ‚îÄ {patientId}/
‚îÇ           ‚îî‚îÄ‚îÄ session_{timestamp}.json
‚îú‚îÄ‚îÄ feedback/          # –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
‚îÇ   ‚îî‚îÄ‚îÄ {userId}_{timestamp}.json
‚îú‚îÄ‚îÄ temp_audio/        # –í—Ä–µ–º–µ–Ω–Ω—ã–µ –∞—É–¥–∏–æ (–∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞)
‚îÇ   ‚îú‚îÄ‚îÄ voice_*.ogg    # –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –æ—Ç Telegram
‚îÇ   ‚îî‚îÄ‚îÄ voice_*.mp3    # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–ª—è Whisper
‚îî‚îÄ‚îÄ telegram_users.json # –°–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (408KB+)
```

---

## üéõÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
```javascript
// –õ–∏–º–∏—Ç—ã —Ç–æ–∫–µ–Ω–æ–≤
const TOKEN_LIMITS = {
  PATIENT_GENERATION: 1000,  // –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞
  DIALOG: 300,               // –û—Ç–≤–µ—Ç—ã –ø–∞—Ü–∏–µ–Ω—Ç–∞  
  ANALYSIS: 1000             // –ê–Ω–∞–ª–∏–∑ —Å–µ—Å—Å–∏–∏
};

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–æ–ª–æ—Å–∞
const VOICE_CONFIG = {
  MAX_FILE_SIZE: 25,         // MB (–ª–∏–º–∏—Ç Whisper API)
  TEMP_DIR: './temp_audio/', // –ü–∞–ø–∫–∞ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
  CLEANUP_AGE: 24            // –ß–∞—Å—ã –¥–æ –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∏
};

// –ú–æ–¥–µ–ª—å Claude
const CLAUDE_MODEL = 'claude-3-5-haiku-20241022';
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
# –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
ANTHROPIC_API_KEY=sk-ant-api03-...
TELEGRAM_BOT_TOKEN=7234567890:AAE...

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ
OPENAI_API_KEY=sk-proj-...  # –¢–æ–ª—å–∫–æ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
PORT=3001                   # –î–ª—è contact-api.js
```

---

## üö® –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏
```javascript
// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
{
  totalRequests: 1250,
  cacheHits: 892,           // 71% –ø–æ–ø–∞–¥–∞–Ω–∏–π
  cacheMisses: 358,
  tokensWrittenToCache: 45000,
  tokensReadFromCache: 125000,
  costSavings: 0.847        // 84.7% —ç–∫–æ–Ω–æ–º–∏–∏
}

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è  
{
  totalSessions: 23,
  totalExchanges: 186,
  sessionsByCategory: {
    "anxiety": 8,
    "mood": 5,
    "trauma": 3
  },
  savedPatients: 12
}
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
```javascript
// –û—Å–Ω–æ–≤–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å
console.log('‚úÖ [PatientSystem] –ü–∞—Ü–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω:', patient.name);
console.log('üé§ [VoiceHandler] –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
console.log('üíæ [CacheManager] Cache hit - —ç–∫–æ–Ω–æ–º–∏—è —Ç–æ–∫–µ–Ω–æ–≤');
console.error('‚ùå [TelegramBot] –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:', error);
```

---

## üîß –î–µ–ø–ª–æ–π –∏ –ø—Ä–æ–¥–∞–∫—à–µ–Ω

### PM2 –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```bash
# –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ PM2
./unified-start.sh pm2

# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
pm2 logs psycho-supervisor-bot   # –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
pm2 restart psycho-supervisor-bot # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
pm2 stop psycho-supervisor-bot    # –û—Å—Ç–∞–Ω–æ–≤–∫–∞
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ñ–∞–π–ª–æ–≤
```bash
# –†–∞–∑–º–µ—Ä –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
ls -lah telegram_users.json     # ~408KB (–∫—Ä–∏—Ç–∏—á–Ω–æ –ø—Ä–∏ 1MB+)
du -sh patients/                # –†–∞—Å—Ç–µ—Ç —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π  
du -sh sessions/                # –ê—Ä—Ö–∏–≤ –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π
du -sh temp_audio/              # –î–æ–ª–∂–µ–Ω –∞–≤—Ç–æ–æ—á–∏—â–∞—Ç—å—Å—è
```

### Backup —Å—Ç—Ä–∞—Ç–µ–≥–∏—è
```bash
# –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –±—ç–∫–∞–ø
tar -czf backup_$(date +%Y%m%d).tar.gz \
    patients/ sessions/ telegram_users.json

# –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∞—É–¥–∏–æ (cron)
0 2 * * * find /root/supervisor/temp_audio -mtime +1 -delete
```

---

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

**1. –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
pm2 logs psycho-supervisor-bot
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ Telegram
curl "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getMe"
```

**2. –û—à–∏–±–∫–∏ Claude API**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–∞ Anthropic
curl -H "x-api-key: $ANTHROPIC_API_KEY" \
     https://api.anthropic.com/v1/messages
```

**3. –ü—Ä–æ–±–ª–µ–º—ã —Å –≥–æ–ª–æ—Å–æ–º**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ FFmpeg
ffmpeg -version
# –ü—Ä–æ–≤–µ—Ä–∫–∞ OpenAI –∫–ª—é—á–∞  
curl -H "Authorization: Bearer $OPENAI_API_KEY" \
     https://api.openai.com/v1/models
```

**4. –ü–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏**
```bash
# –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
gzip telegram_users.json
# –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–µ—Å—Å–∏–π
find sessions/ -mtime +90 -name "*.json" -compress
```

### –†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏
```javascript
// –í–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
const DEBUG = process.env.NODE_ENV === 'development';
if (DEBUG) {
  console.log('üîç [DEBUG] –î–∞–Ω–Ω—ã–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞:', JSON.stringify(patient, null, 2));
  console.log('üîç [DEBUG] –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userSession);
}
```

---

## üìà –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤
```javascript
// –í patient-system.js
this.casesDB.newCategory = {
  name: "–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è",
  description: "–û–ø–∏—Å–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏",
  cases: {
    subtype1: {
      name: "–ü–æ–¥—Ç–∏–ø 1", 
      description: "–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–¥—Ç–∏–ø–∞",
      complexity: 3
    }
  }
};
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∫–æ–º–∞–Ω–¥—ã
```javascript
// –í telegram-bot.js
bot.onText(/\/newcommand/, async (msg) => {
  const userId = msg.from.id;
  const userSession = getUserSession(userId);
  
  // –õ–æ–≥–∏–∫–∞ –∫–æ–º–∞–Ω–¥—ã
  await bot.sendMessage(userId, "–û—Ç–≤–µ—Ç –∫–æ–º–∞–Ω–¥—ã");
});
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ API
```javascript
// –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –º–æ–¥—É–ª—è
class NewApiHandler {
  constructor() {
    this.apiKey = process.env.NEW_API_KEY;
  }
  
  async makeRequest(data) {
    // –õ–æ–≥–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
  }
}
```

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

### –ö–æ–Ω—Ç–∞–∫—Ç—ã
- **–ê–≤—Ç–æ—Ä**: –ö–æ–º–∞–Ω–¥–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –ü—Å–∏—Ö–æ–¢—Ä–µ–Ω–µ—Ä
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: `/root/supervisor/README.md`
- **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: `/root/supervisor/CLAUDE.md`

### –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
```bash
# –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
pm2 status
systemctl status telegram-bot

# –õ–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
tail -f /var/log/telegram-bot.log
pm2 logs --lines 50

# –ê–Ω–∞–ª–∏–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
du -sh patients/ sessions/ temp_audio/
df -h /root/supervisor/
```

---

## üîÑ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
1. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: –ú–∏–≥—Ä–∞—Ü–∏—è —Å JSON –Ω–∞ SQLite/PostgreSQL
2. **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: Redis –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π  
3. **–§–∞–π–ª—ã**: S3/MinIO –¥–ª—è –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤ –∏ –∞—Ä—Ö–∏–≤–æ–≤
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: Prometheus + Grafana
5. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: Jest –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤

### –¢–µ–∫—É—â–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
- –§–∞–π–ª–æ–≤–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ (–ø—Ä–æ–±–ª–µ–º—ã –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è)
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
- –†—É—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- –û–¥–∏–Ω instance –±–æ—Ç–∞

---

**üìù –í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏**: 1.0  
**üìÖ –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: 10 –∏—é–Ω—è 2025  
**üîß –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: Node.js 18+, Linux/macOS